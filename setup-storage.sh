#!/bin/bash

echo "üöÄ Setting up Supabase storage bucket for store icons..."

# This script sets up the 'store-icons' bucket in Supabase Storage
# Make sure you have the Supabase CLI installed and configured

echo "üìã Instructions:"
echo "1. Install Supabase CLI: npm install -g supabase"
echo "2. Login to Supabase: supabase login"
echo "3. Link your project: supabase link --project-ref YOUR_PROJECT_REF"
echo "4. Run this script or manually create the bucket"
echo ""

echo "üîß Creating storage buckets 'store-icons' and 'menu-photos'..."

# Create the storage buckets using Supabase CLI
supabase storage buckets create store-icons --public || echo "‚ö†Ô∏è  store-icons bucket might already exist"
supabase storage buckets create menu-photos --public || echo "‚ö†Ô∏è  menu-photos bucket might already exist"

echo ""
echo "üìù Manual Setup (if CLI doesn't work):"
echo "1. Go to your Supabase Dashboard"
echo "2. Navigate to Storage"
echo "3. Create a new bucket named 'store-icons'"
echo "4. Create another bucket named 'menu-photos'"
echo "5. Make both buckets PUBLIC"
echo "6. Set up RLS policies for authenticated users"
echo ""

echo "üîê Setting up Row Level Security (RLS) policies..."

echo "‚ö†Ô∏è  IMPORTANT: You CANNOT run DDL commands on storage.objects table directly!"
echo "   RLS policies for storage must be set up through the Supabase Dashboard."
echo ""

echo "üìã STEP-BY-STEP: Setting up menu-photos bucket in Supabase Dashboard"
echo "=================================================================="
echo ""

echo "üéØ IMPORTANT: You need to be the project OWNER to set up storage policies"
echo ""

echo "üìã STEP 1: Create Storage Buckets"
echo "=================================="
echo ""
echo "1.1. Go to your Supabase Dashboard"
echo "1.2. Click 'Storage' in the left sidebar"
echo "1.3. Click 'New Bucket' button"
echo ""
echo "1.4. Create 'store-icons' bucket:"
echo "   ‚Ä¢ Name: store-icons"
echo "   ‚Ä¢ Public bucket: ‚úÖ YES (check the box)"
echo "   ‚Ä¢ Click 'Create Bucket'"
echo ""
echo "1.5. Create 'menu-photos' bucket:"
echo "   ‚Ä¢ Name: menu-photos"
echo "   ‚Ä¢ Public bucket: ‚úÖ YES (check the box)"
echo "   ‚Ä¢ Click 'Create Bucket'"
echo ""

echo "üìã STEP 2: Set Up RLS Policies for Each Bucket"
echo "==============================================="
echo ""
echo "2.1. For 'store-icons' bucket:"
echo "   ‚Ä¢ Click on 'store-icons' bucket"
echo "   ‚Ä¢ Go to 'Policies' tab"
echo "   ‚Ä¢ Click 'New Policy'"
echo ""
echo "   Policy 1 - Upload Permission:"
echo "   ‚Ä¢ Policy Name: 'Authenticated users can upload store icons'"
echo "   ‚Ä¢ Operation: INSERT"
echo "   ‚Ä¢ Target Roles: authenticated"
echo "   ‚Ä¢ Policy Definition: bucket_id = 'store-icons'"
echo "   ‚Ä¢ Click 'Save Policy'"
echo ""
echo "   Policy 2 - Public Read Permission:"
echo "   ‚Ä¢ Policy Name: 'Public read access for store icons'"
echo "   ‚Ä¢ Operation: SELECT"
echo "   ‚Ä¢ Target Roles: public"
echo "   ‚Ä¢ Policy Definition: bucket_id = 'store-icons'"
echo "   ‚Ä¢ Click 'Save Policy'"
echo ""

echo "2.2. For 'menu-photos' bucket:"
echo "   ‚Ä¢ Click on 'menu-photos' bucket"
echo "   ‚Ä¢ Go to 'Policies' tab"
echo "   ‚Ä¢ Click 'New Policy'"
echo ""
echo "   Policy 1 - Upload Permission:"
echo "   ‚Ä¢ Policy Name: 'Authenticated users can upload menu photos'"
echo "   ‚Ä¢ Operation: INSERT"
echo "   ‚Ä¢ Target Roles: authenticated"
echo "   ‚Ä¢ Policy Definition: bucket_id = 'menu-photos'"
echo "   ‚Ä¢ Click 'Save Policy'"
echo ""
echo "   Policy 2 - Public Read Permission:"
echo "   ‚Ä¢ Policy Name: 'Public read access for menu photos'"
echo "   ‚Ä¢ Operation: SELECT"
echo "   ‚Ä¢ Target Roles: public"
echo "   ‚Ä¢ Policy Definition: bucket_id = 'menu-photos'"
echo "   ‚Ä¢ Click 'Save Policy'"
echo ""

echo "üìã STEP 3: Verify Setup"
echo "======================="
echo ""
echo "3.1. Check buckets exist:"
echo "   ‚Ä¢ Go to Storage section"
echo "   ‚Ä¢ Verify both 'store-icons' and 'menu-photos' appear"
echo "   ‚Ä¢ Both should show as 'Public'"
echo ""

echo "3.2. Check policies:"
echo "   ‚Ä¢ Click each bucket"
echo "   ‚Ä¢ Go to 'Policies' tab"
echo "   ‚Ä¢ Verify you have 2 policies per bucket"
echo ""

echo "3.3. Test upload:"
echo "   ‚Ä¢ Try uploading a small image in admin dashboard"
echo "   ‚Ä¢ Should work without errors"
echo ""

echo "üìã STEP 4: Troubleshooting"
echo "=========================="
echo ""
echo "‚ùå 'Permission denied' errors?"
echo "   ‚Üí Make sure you're logged in as project owner"
echo "   ‚Üí Check that you're in the correct Supabase project"
echo ""

echo "‚ùå 'Bucket not found' errors?"
echo "   ‚Üí Double-check bucket names are exact"
echo "   ‚Üí Verify buckets are set to PUBLIC"
echo ""

echo "‚ùå Upload still fails?"
echo "   ‚Üí Check browser console for detailed error messages"
echo "   ‚Üí Verify RLS policies are correctly configured"
echo ""

echo "üéâ SUCCESS INDICATORS:"
echo "======================"
echo ""
echo "‚úÖ Both buckets appear in Storage section"
echo "‚úÖ Both buckets show as 'Public'"
echo "‚úÖ Each bucket has 2 policies in Policies tab"
echo "‚úÖ Admin can upload store icons and menu photos"
echo "‚úÖ Images display correctly in the app"
echo ""

echo "üîß ALTERNATIVE: Command Line Setup"
echo "=================================="
echo ""
echo "If you prefer using Supabase CLI:"
echo ""
echo "supabase storage buckets create store-icons --public"
echo "supabase storage buckets create menu-photos --public"
echo ""
echo "üìù Note: CLI setup still requires manual policy configuration in Dashboard"
echo ""

echo "‚úÖ SETUP COMPLETE!"
echo "=================="
echo ""
echo "üéØ Your storage buckets are now ready for:"
echo "   ‚Ä¢ Store icon uploads (admin settings)"
echo "   ‚Ä¢ Menu photo uploads (admin menu management)"
echo "   ‚Ä¢ Public access for displaying images"
echo ""

echo "üöÄ Ready to use all features!"
echo ""

echo "üí° TIP: Keep this window open while setting up - you can refer back to these steps!"
